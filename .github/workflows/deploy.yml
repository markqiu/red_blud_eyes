name: Deploy to Cloud

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Create .env from secrets
        run: |
          cat > .env << 'EOF'
          SILICONFLOW_BASE_URL=${{ secrets.SILICONFLOW_BASE_URL || 'https://api.siliconflow.cn/' }}
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY || '' }}
          SILICONFLOW_MODEL=${{ secrets.SILICONFLOW_MODEL || 'deepseek-ai/DeepSeek-V3.2' }}
          OPENAI_CERTAINTY_THRESHOLD=${{ secrets.OPENAI_CERTAINTY_THRESHOLD || '0.95' }}
          RENDER_API_KEY=${{ secrets.RENDER_API_KEY || '' }}
          EOF
      
      - name: Install dependencies
        run: uv pip install --system -r requirements.txt
      
      - name: Run tests
        run: uv run pytest -q

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Create .env from secrets
        run: |
          cat > .env << 'EOF'
          SILICONFLOW_BASE_URL=${{ secrets.SILICONFLOW_BASE_URL || 'https://api.siliconflow.cn/' }}
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY || '' }}
          SILICONFLOW_MODEL=${{ secrets.SILICONFLOW_MODEL || 'deepseek-ai/DeepSeek-V3.2' }}
          OPENAI_CERTAINTY_THRESHOLD=${{ secrets.OPENAI_CERTAINTY_THRESHOLD || '0.95' }}
          RENDER_API_KEY=${{ secrets.RENDER_API_KEY || '' }}
          EOF
      
      - name: Build dependencies
        run: uv pip install --system -r requirements.txt

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -n "$RAILWAY_TOKEN" ]; then
            echo "Installing Railway CLI..."
            npm install -g @railway/cli
            
            echo "Deploying to Railway..."
            railway up --detach
            
            echo "✅ Deployment to Railway triggered"
          else
            echo "⚠️ Skipping Railway deployment: RAILWAY_TOKEN not configured"
          fi

  notify:
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "=== CI/CD Status ==="
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Tests passed"
          else
            echo "❌ Tests failed"
          fi
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ Build successful"
          else
            echo "❌ Build failed"
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deployment successful"
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "⏭️ Deployment skipped (RENDER_DEPLOY_HOOK not configured)"
          else
            echo "❌ Deployment failed"
          fi
