name: Deploy to Cloud

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Create .env from secrets
        run: |
          cat > .env << 'EOF'
          SILICONFLOW_BASE_URL=${{ secrets.SILICONFLOW_BASE_URL || 'https://api.siliconflow.cn/' }}
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY || '' }}
          SILICONFLOW_MODEL=${{ secrets.SILICONFLOW_MODEL || 'deepseek-ai/DeepSeek-V3.2' }}
          OPENAI_CERTAINTY_THRESHOLD=${{ secrets.OPENAI_CERTAINTY_THRESHOLD || '0.95' }}
          RENDER_API_KEY=${{ secrets.RENDER_API_KEY || '' }}
          EOF
      
      - name: Install dependencies
        run: uv pip install --system -r requirements.txt
      
      - name: Run tests
        run: uv run pytest -q

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Create .env from secrets
        run: |
          cat > .env << 'EOF'
          SILICONFLOW_BASE_URL=${{ secrets.SILICONFLOW_BASE_URL || 'https://api.siliconflow.cn/' }}
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY || '' }}
          SILICONFLOW_MODEL=${{ secrets.SILICONFLOW_MODEL || 'deepseek-ai/DeepSeek-V3.2' }}
          OPENAI_CERTAINTY_THRESHOLD=${{ secrets.OPENAI_CERTAINTY_THRESHOLD || '0.95' }}
          RENDER_API_KEY=${{ secrets.RENDER_API_KEY || '' }}
          EOF
      
      - name: Build dependencies
        run: uv pip install --system -r requirements.txt

  sync-env:
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      - name: Check Railway token
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "RAILWAY_TOKEN not set; skipping env sync." && exit 0
          fi
          echo "Railway token configured"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Link Railway project
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "RAILWAY_PROJECT_ID not set; skipping env sync." && exit 0
          fi
          railway link --project "$RAILWAY_PROJECT_ID"

      - name: Sync variables to service
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          SILICONFLOW_BASE_URL: ${{ secrets.SILICONFLOW_BASE_URL }}
          SILICONFLOW_MODEL: ${{ secrets.SILICONFLOW_MODEL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          set_var() { 
            key="$1"
            val="$2"
            if [ -n "$val" ]; then 
              echo "Setting $key"
              railway variables --set "$key=$val"
            fi
          }
          set_var SILICONFLOW_API_KEY "$SILICONFLOW_API_KEY"
          set_var SILICONFLOW_BASE_URL "$SILICONFLOW_BASE_URL"
          set_var SILICONFLOW_MODEL "$SILICONFLOW_MODEL"
          set_var OPENAI_API_KEY "$OPENAI_API_KEY"
          set_var OPENAI_BASE_URL "$OPENAI_BASE_URL"
          set_var OPENAI_MODEL "$OPENAI_MODEL"
          set_var APP_PASSWORD "$APP_PASSWORD"

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: Deployment Info
        run: |
          echo "✅ Build successful!"
          echo ""
          echo "To deploy to Railway:"
          echo "1. Visit https://railway.app/dashboard"
          echo "2. Click 'New Project'"
          echo "3. Select 'Deploy from GitHub repo'"
          echo "4. Choose 'markqiu/red_blud_eyes'"
          echo "5. Railway will automatically deploy using Dockerfile"
          echo ""
          echo "Alternative: Use Railway CLI locally"
          echo "  railway login"
          echo "  railway link"
          echo "  railway up"

  notify:
    needs: [test, build, sync-env, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "=== CI/CD Status ==="
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Tests passed"
          else
            echo "❌ Tests failed"
          fi
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ Build successful"
          else
            echo "❌ Build failed"
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deployment successful"
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "⏭️ Deployment skipped (RENDER_DEPLOY_HOOK not configured)"
          else
            echo "❌ Deployment failed"
          fi
